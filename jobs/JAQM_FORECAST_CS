#!/bin/ksh

source /opt/modules/default/init/ksh
#module load prod_util


date
export PS4=' $SECONDS + '
set -x

export DATA=${DATA:-${DATAROOT:?}/${jobid}}
mkdir -p ${DATA}
cd ${DATA}

export cycle=${cycle:-t${cyc}z}
setpdy.sh
. PDY

export SENDDBN=${SENDDBN:-YES}
export SENDECF=${SENDECF:-YES}
export SENDCOM=${SENDCOM:-YES}

export HOMEaqm=${HOMEaqm:-${NWROOT}/cmaq.${cmaq_ver}}
export USHaqm=${USHaqm:-${HOMEaqm}/ush}
export EXECaqm=${EXECaqm:-${HOMEaqm}/exec}
export PARMaqm=${PARMaqm:-${HOMEaqm}/parm}
export FIXaqm=${FIXaqm:-${HOMEaqm}/fix}
export UTILaqm=${UTILaqm:-${HOMEaqm}/util}

export NET=${NET:-aqm}
export RUN=${RUN:-aqm}

export COMIN=${COMIN:-${COMROOT}/${NET}/${envir}/${RUN}.${PDY}}
export COMINm1=${COMINm1:-${COMROOT}/${NET}/${envir}/${RUN}.${PDYm1}}
export COMINm2=${COMINm2:-${COMROOT}/${NET}/${envir}/${RUN}.${PDYm2}}
export COMINm3=${COMINm3:-${COMROOT}/${NET}/${envir}/${RUN}.${PDYm3}}

export COMOUT=${COMOUT:-${COMROOT}/${NET}/${envir}/${RUN}.${PDY}}
export COMOUTm1=${COMOUTm1:-${COMROOT}/${NET}/${envir}/${RUN}.${PDYm1}}

## Define Input directories for various information
YM=`echo ${PDY} | cut -c1-6`
export EMISpath=${EMISpath:-/gpfs/hps/nco/ops/com/aqm/prod/emission/${YM}}  #> emissions input directory
if [ "${FCST}" = "YES" ] ; then
   METpath=${COMIN} #> meteorology input directory
else
   METpath=${COMINm1}
fi
export METpath=${METpath:-${COMIN}} #> CMAQ processed meteorology directory
export BCpath=${BCpath:-${METpath}} #> boundary conditions input  directory

export jlogfile=${jlogfile:-${COMROOT}/logs/jlogfiles/jlogfile.${jobid}}

mkdir -p ${COMOUT}

export pgmout=OUTPUT.$$

export KEEPDATA=${KEEPDATA:-YES}
## ALERT HHC remove for NCO delivery
export SINGLECYC=${SINGLECYC:-NO}

env

###################################################
# Execute the Script
###################################################
${HOMEaqm}/scripts/exaqm_cmaqv531_cs.sh.ecf
export err=$?; err_chk

##################################################
if [ -e "${pgmout}" ]; then
   cat ${pgmout}
fi

msg="JOB $job HAS COMPLETED NORMALLY."
postmsg "${jlogfile}" "${msg}"

###################################
# Remove temp directories
###################################
if [ "${KEEPDATA}" != "YES" ] ; then
  rm -rf ${DATA}
fi

date
